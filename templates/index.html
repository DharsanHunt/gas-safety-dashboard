<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gas Safety Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Inter,system-ui;background:linear-gradient(135deg,#f5f7fa,#e9ecef);padding:24px}
.container{max-width:1400px;margin:auto}
.metric-card,.stats-panel,.chart-section,header,.alert-banner,.footer{background:white;border-radius:16px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin:24px 0}
.metric-value{font-size:2.2rem;font-weight:700}
.status-safe{background:#22c55e}
.status-danger{background:#ef4444;animation:pulse 1.5s infinite}
.status-indicator{width:10px;height:10px;border-radius:50%}
.chart-container{height:360px}
@keyframes pulse{50%{opacity:.5}}
</style>
</head>

<body>
<div class="container">

<header>
<h1>Gas Safety Monitoring</h1>
</header>

<div id="alertBanner" class="alert-banner safe">
<h2 id="alertTitle">System Normal</h2>
<p id="alertMessage">All gas levels safe</p>
</div>

<div class="metrics-grid">
<div class="metric-card">
<div class="metric-value" id="gas">--</div>
<div><span id="statusIndicator" class="status-indicator status-safe"></span> <span id="state">--</span></div>
</div>

<div class="metric-card">
<div class="metric-value">2000</div>
<p>Safety Threshold</p>
</div>

<div class="metric-card">
<div class="metric-value" id="time">--</div>
<p>Last Updated</p>
</div>
</div>

<div class="stats-panel">
<p>Average: <span id="avgLevel">--</span></p>
<p>Peak: <span id="peakLevel">--</span></p>
<p>Min: <span id="minLevel">--</span></p>
<p>Points: <span id="dataPoints">0</span></p>
</div>

<div class="chart-section">
<div class="chart-container">
<canvas id="gasChart"></canvas>
</div>
</div>

<div class="footer">Real-time Monitoring Active</div>

</div>

<script>
const GAS_THRESHOLD = 2000
const MAX_POINTS = 30
const SMOOTH_WINDOW = 5

let labels=[]
let rawGas=[]
let smoothGas=[]
let thresholdData=[]
let previousGas=null

let stats={sum:0,count:0,peak:0,min:Infinity}

function movingAverage(d,w){
 if(d.length<w) return d[d.length-1]
 return Math.round(d.slice(-w).reduce((a,b)=>a+b)/w)
}

function updateStatistics(v){
 stats.sum+=v
 stats.count++
 stats.peak=Math.max(stats.peak,v)
 stats.min=Math.min(stats.min,v)
 document.getElementById("avgLevel").innerText=Math.round(stats.sum/stats.count)
 document.getElementById("peakLevel").innerText=stats.peak
 document.getElementById("minLevel").innerText=stats.min
 document.getElementById("dataPoints").innerText=stats.count
}

const ctx=document.getElementById("gasChart")

const gasChart=new Chart(ctx,{
 type:"line",
 data:{
  labels,
  datasets:[
   {
    label:"Gas Level",
    data:smoothGas,
    borderColor:"#3b82f6",
    tension:.4,
    fill:true,
    backgroundColor:"rgba(59,130,246,.1)"
   },
   {
    label:"Threshold",
    data:thresholdData,
    borderColor:"#ef4444",
    borderDash:[6,6],
    fill:false
   }
  ]
 },
 options:{
  responsive:true,
  maintainAspectRatio:false,
  scales:{
   y:{
    suggestedMin:600,
    suggestedMax:2500
   }
  }
 }
})

async function updateData(){
 try{
  const res=await fetch("/data",{cache:"no-store"})
  const data=await res.json()

  document.getElementById("gas").innerText=data.gas
  document.getElementById("state").innerText=data.state
  document.getElementById("time").innerText=data.time

  updateStatistics(data.gas)

  const indicator=document.getElementById("statusIndicator")
  const banner=document.getElementById("alertBanner")
  const title=document.getElementById("alertTitle")
  const msg=document.getElementById("alertMessage")

  if(data.gas>GAS_THRESHOLD){
   indicator.className="status-indicator status-danger"
   banner.className="alert-banner danger"
   title.innerText="Gas Leak Detected"
   msg.innerText="Danger level exceeded!"
  }else{
   indicator.className="status-indicator status-safe"
   banner.className="alert-banner safe"
   title.innerText="System Normal"
   msg.innerText="Gas within safe range"
  }

  rawGas.push(data.gas)
  labels.push(data.time)
  smoothGas.push(movingAverage(rawGas,SMOOTH_WINDOW))
  thresholdData.push(GAS_THRESHOLD)

  if(labels.length>MAX_POINTS){
   labels.shift()
   smoothGas.shift()
   thresholdData.shift()
  }

  gasChart.update()

 }catch(e){console.log(e)}
}

setInterval(updateData,1000)
updateData()
</script>

</body>
</html>
